---
layout: post
title:  "热点账户问题的解决与识别"
date:   2018-07-11 12:00:00

categories: tool
tags: archtecture refactoring tool
author: "XueGang Zhang"
image: /images/logo.png
comments: true
published: true
---

#### 背景介绍

账务系统作为互联金融领域的基石系统，承载着所有账户的资金管控，那保持它的稳定可靠是系统建设的第一要务，我们知道在数据库中某个账户余额是一行记录，如果一个大商户每天出入金巨大，那就涉及到对该行记录频繁的更新，这对数据库是巨大的考验，接下来我就和大家一起聊一聊怎么去解决和规避这种频繁的操作问题。

今天分享的是关于如何解决互联网热点账户的问题。互联网解决了人们交易活动地域上的限制，产生了很多巨无霸的商家，对这些巨无霸商家的交易账户的操作就成了热点操作，因为明细和余额的更新是在一个事务中进行，但是对余额操作是稀缺的资源，所以更新余额就成了瓶颈。今天我和大家一起来聊一下如何解决和规避热点账户的问题（图1）。

<p align="center">
	<img src="https://uploader.shimo.im/f/skr22p7b3x8cq8w8.png" alt="Sample"  width="70%" height="70%">
	<p align="center">
		<em>图1</em>
	</p>
</p>

#### 三户模型
首先我们看一下什么是账户。支付行业的账户体系一般是基于三户模型，客户一般来说是一个比较社会化的概念，比如一个自然和一个法人都可以被称之为客户，一般来在系统中会将客户划分为个人和企业；用户是指客户在系统的登录账号信息，包括账号、密码、角色、权限这些；账户是指我们为客户开设的进行交易活动的的虚拟账户，主要与交易记账相关，我们说的热点账户，指的就是这个账户（图2）。

![Alt text](https://uploader.shimo.im/f/RrrDRs18FbIETdMU.png)

#### 热点账户的分类
那热点账户有哪些分类呢，我们按资金发生的方向来分，分为加频账户、减频账户和双频账户，
顾名思义，加频账户就是入金比较频繁的账户，募捐账户是典型的加频账户，比如这次新冠状病毒的疫情组织的一些筹款活动，大家的爱国热情特别高，募捐的账户接受大量的捐款信息。假设用户的付款方式都是通过在第三方支付里开设的虚拟账户进行出款,募捐账户的金额到达目标金额后进行结算（图3）。

![Alt text](https://uploader.shimo.im/f/iOdav7fPDC87N34M.png)

与加频账户对应的就是减频账户，比如给员工发公司的账户、平台在第三方支付公司为增加用户体验设置的退款垫资户，这些都是典型的减频账户。双频账户也比较好理解，比如是平台性质的商户，用户在平台进行下单购物，这个时候的资金流是该用户的钱，会先收取到该平台在第三方支付公司开设的内部户，然后转账给该平台的商户，这个时候这个平台的账户就是一个双频账户(图4)。

![Alt text](https://uploader.shimo.im/f/drNOJ5I2CssPnJTv.png)

那怎么去解决这些热点账户的问题呢，这里我介绍一下支付公司常用的几种方法，上面也说了这些方法根本解决的问题没有变化，就是降低更新余额的瓶颈。首先我们来看一下第一种方式，限流。限流与缓存 、降级常常被作为高并发系统设计的三大利器，限流作为保护系统的一道防线。当系统超过承载能力的时候起到了很好的兜底保障。他的原则很清晰，超出我能力范围的我不要(图5)。

![Alt text](https://uploader.shimo.im/f/Y5OKRyME8zAKG7XO.png)

这种方式很好的保护了系统，我们也看到了，他是通过拒绝了部分请求，来保障系统，这样对请求方有损的，影响客户体验，所以这个方法一般是系统压测后，得到系统的承载阈值，作为最后系统保障的兜底措施。

缓冲实际上就是同步转异步，通过异步的方式先将请求接收下来，然后放到可靠的消息队列中，然后将结果返回给调用方，之后从消息队列中取出请求慢慢处理，做到“削峰填谷”的功能（图6）。

![Alt text](https://uploader.shimo.im/f/AIT7d6j6sLIrEpbO.png)


缓冲是一种比较简单有效的方式，但是如果量太大，造成大量的积压，日间的平均处理能力不能消费总量的时候，还需要其它的方案。对于余额扣减的操作，同时也存在账户透支的风险。如果余额不足的情况也需要异步的通知给用户。

回到问题的本质，因为稀缺资源是在余额上，每笔交易都要更新余额，那我们是不是可以先将请求明细保存起来。标识一下这条明细的状态，并标记改明细的汇总批次，后边通过定时任务，按批次对期间的明细进行汇总，一次性更新余额。并修改明细状态（图7）。

![Alt text](https://uploader.shimo.im/f/NvJyzdZjWMUmezo9.png)

这种汇总的方式，实现起来比较简单，但是比较适合于加频账户。另一个缺点就是账户余额更新不及时，取决于批次的间隔。

实际上热点问题类似于秒杀、减库存的问题，库存热点很多是采用对库存进行拆分，那账户实际上是不是也可以参考库存的方案，拆分为多个影子账户，来承担主商户的压力（图8）。

![Alt text](https://uploader.shimo.im/f/OMmilherGAo0VuIl.png)

这个方案看上去很美好，但是库和账户的处理还是有很多不同的，这种方式，其实存在很多问题。如何平衡各个影子账户的资金，如果某个影子账户的余额不足，需要扣多个影子账户怎么处理，流水中金额前后的变动无法体现。

缓存是高并发系统的又一个利器，将余额同步一部分到缓存中，然后对缓存的数据进行更新。后续可以在交易的低峰期进行对账操作，防止缓存故障导致的数据一致性问题，也是处理热点账户的一种比较常用的方式，但是这种账户一般只针对于减频账户(图9)。

![Alt text](https://uploader.shimo.im/f/0qYkOEVd3lYKxcri.png)

那么说了这么多针对热点账户的解决方法，热点账户要怎样识别呢，有事前配置的，也有使用redis计数器的，热点账户的识别因为比较具象，所以比热点事情的识别相比来说要容易很多。我这里介绍一个通过大数据平台来识别的方式简单方式。通过Spark Streaming的窗口计算(window computations)的功能，分析当前窗口下数据访问次数统计，最终发现热点key，把热点key上报给配置中心，再从配置中心下发给各个客户端，来实现热点账户的识别与处理的自动化（图10）。

![Alt text](https://uploader.shimo.im/f/44k2dOkJZvodW7d6.png)

今天的分享到这里就结束了，最后我给你总结一下。今天首先首先介绍了热点账户的成因，顺带说了下支付机构的账户体系模型，热点账户的分类最后重点介绍了如何解决热点账户的几种方案。

解决热点账户的核心就是怎么最大限度的去减少对稀有资源的争用。每种减少的方式都有它的优势和缺陷，在热点账户的解决上，也没有银弹。在实操过程中都需要按照业务场景以及账户的类型去权衡。

最后我们通过思维导图来梳理一下今天的知识点，让你对热点账户的解决方式有一个更直观的认识。（图11）

![Alt text](https://uploader.shimo.im/f/oxVCYaYlF48pMJ91.png)

好，我是张学刚，希望我的分享可以帮助到你，也希望你在视频下方的留言区和我参与讨论。