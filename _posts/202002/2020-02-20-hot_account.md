---
layout: post
title:  "热点账户问题的解决与识别"
date:   2018-07-11 12:00:00

categories: tool
tags: archtecture refactoring tool
author: "XueGang Zhang"
image: /images/logo.png
comments: true
published: true
---

#### 背景介绍
账务系统作为互联金融领域的基石系统，承载着所有账户的资金管控，那保证它的稳定可靠是系统建设的第一要务，我们知道在数据库中某个账户余额是一行记录，如果一个大商户每天出入金巨大，那就涉及到对该行记录频繁的更新，这对数据库是巨大的考验，接下来我就和大家一起聊一聊怎么去解决和规避这种频繁的操作问题。

今天分享的是关于如何解决互联网热点账户的问题。互联网解决了人们交易活动地域上的限制，产生了很多巨无霸的商家，对这些巨无霸商家交易账户的操作就成了热点操作，这些热点操作主要体现在账户的明细和余额上面，而这两个操作的更新又是在一个事务中进行的，但是对余额操作是稀缺的资源，所以更新余额就成了瓶颈。今天我和大家一起来聊一下如何解决和规避热点账户的问题（图1）。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/01.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图1</em>
	</p>
</p>

#### 三户模型
如图所示，上面是某个商户的交易数据，假设4个交易数据同时过来，它们同时对明细进行插入，然后更新余额，这个时候我们可以看到，因为他们更新的是同一个账户的余额，所以这个时候，需要竞争对该行的操作权。该行成为热点行。这也就是我们上边所说的热点账户问题。

我们上边聊到了账户，那我们先来看一下什么是账户呢？支付行业的账户体系一般是基于三户模型，它们分别是客户、用户和账户。客户一般来说是一个比较社会化的概念，比如一个自然人和一个法人都可以被称之为客户，在系统中我们会将客户划分为个人和企业；用户是指客户在系统中登录账号的相关信息：包括账号、密码、角色、权限这些；账户是指我们为客户进行交易活动而开设的虚拟账户，主要与交易记账相关，我们说的热点账户，指的就是这个账户（图2）。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/02.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图2</em>
	</p>
</p>

通过这个图我们可以看出，客户、用户、和账户之间的关系。一般一个客户，可以注册多个用户，也可以在不同的业务下开通多个账户，所以客户和用户以及客户与账户之间都是一个1对多的关系。一个用户呢可以操作多个账户，反过来多个账户也可以同时被一个用户操作，用户和账户之间是多对多的关系。


#### 热点账户的分
那现在我们知道什么是账户和热点账户了，那热点账户有哪些分类呢，一般我们按资金发生的方向来分，可以分为加频账户、减频账户和双频账户，顾名思义，加频账户就是入金比较频繁的账户，比如募捐账户是典型的加频账户，这次新冠病毒的疫情组织的一些筹款活动，大家的爱国热情特别高，募捐的账户接受大量的捐款信息。假设用户的付款方式都是通过在第三方支付里开设的虚拟账户进行出款,募捐账户的金额到达目标金额后进行结算，那我们看一下他的资金流。(图3)

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/03.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图3</em>
	</p>
</p>

##### 减频/双频账户
我们看到，这个时候大量的资金同时进入受款商户的待清算户，这个受款商户的待清算户成为加频热点账户。

与加频账户对应的就是减频账户，比如给员工发公司的账户、平台在第三方支付公司为增加用户体验设置的退款垫资户，这些都是典型的减频账户。双频账户也比较好理解，比如是电商平台性质的商户在支付公司的一个资金流(图4)。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/04.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图4</em>
	</p>
</p>

用户在平台进行下单购物，这个时候的该用户的钱，会先收取到该平台在第三方支付公司开设的内部户，然后转账给该平台的商户。这个时候该平台在第三方支付开设的内部户，就是一个双频账户。

#### 解决热点账户的问题

##### 限流
介绍完上边的几类账户，现在进入我今天的重点部分，那就是如何去解决这些热点账户的问题？这里我介绍一下支付公司常用的几种方法。我们上边也说了，热点账户的瓶颈是因为大家同时竞争对余额的操作权，更新余额成为稀缺资源，那么我们核心宗旨减少单位时间内对余额的操作。首先我们来看一下第一种方式，限流。限流与缓存 、降级常常被作为高并发系统设计的三大利器。它是最直接的减少单位时间内余额操作的方式，它的原则很清晰，超出我能力范围的我不要（图5）。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/05.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图5</em>
	</p>
</p>

如图上我们看到的，这种方式很直接的减少了对商户余额的操作，但是我们也可以看到，它是通过拒绝了部分请求来实现的，这样对请求方是有损的，影响客户体验。所以这个方法一般是系统压测后，得到系统的承载阈值，作为系统保障的兜底措施来使用。

##### 缓冲
基于互联网的一些特点很多时候洪峰是瞬时的，那我们是不是可以先把瞬时的请求接下来，存在一个地方，然后再通过比较平均的速度，来处理这些数据呢？这就是我介绍的第二种方法：缓冲（图6）。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/06.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图6</em>
	</p>
</p>

我们可以看到，缓冲实际上就是同步转异步，先将请求接收下来，将请求放到可靠的消息队列中，并将结果返回给调用方，之后从消息队列中取出请求慢慢处理，用“削峰填谷”的方式来降低单位时间内对余额的操作。

##### 批量
那这种方式有什么问题呢，如果量太大，造成大量的积压，可能会导致日间的平均处理能力不能完成对整个队列的消费，最终造成循环积压。这种方案对于余额扣减的场景，因为消息积压还没有被消费，同时也存在账户透支的风险，这个时候当发生余额不足的时候需要及时的通知给调用方。

那还有什么方式来减小单位时间内对余额的操作呢，我们是不是可以通过汇总明细一次性提交更新余额的方式来减少更新余额的频次呢，这种汇总提交的方式也是第三方支付公司常用的方式。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/07.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图7</em>
	</p>
</p>

如图，我们先将请求明细保存起来。标识一下这条明细的状态，并标记该明细的汇总批次，后边通过定时任务，按批次对期间的明细进行汇总，一次性更新余额。并修改明细状态（图7）。这种汇总的方式，实现起来比较简单，比较适合于加频账户。但是他的缺点就是账户余额更新不够及时。

##### 分治
除了降低余额的更新频次，还有没有其它方式呢？实际上热点问题类似于秒杀、减库存的问题，也可以参考库存热点的方式来做，将库存拆分，采用分治的思想。理论上账户也可以拆分为多个影子账户，来承担主商户的压力（图8）。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/08.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图8</em>
	</p>
</p>

如图，商户的交易通过影子账户的路由，分流到不同的影子账户进行余额操作，最终达到单位时间内对单个账户余额的更新次数。这个方案看上去很好，但是库存和账户的处理还是有很多不同的，这里还是存在很多问题点。比如如何平衡各个影子账户的资金，如果某个影子账户的余额不足，需要扣多个影子账户要怎么处理。流水中金额前后的变动无法体现。

##### 缓存
基于上边这个方案的一些不足点，我们考虑在方案中使用缓存的方式，缓存是高并发系统的又一个利器，将余额同步一部分到缓存中，当请求过来后先对缓存的余额进行操作。让缓存来阻挡住对数据库余额的频繁操作(图9)。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/09.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图9</em>
	</p>
</p>

如图，我们先将商户余额同步到缓存中，请求到达后，优先对缓存中的余额进行操作。后续可以在交易的低峰期进行对账操作，防止缓存故障导致的数据一致性问题，这种也是处理热点账户的一种比较常用的方式。但是这种账户一般只针对于减频账户(图9)。


#### 热点账户识别
那么说了这么多针对热点账户的解决方法，热点账户要怎样识别呢。我见过的账务系统，有事前配置的，也有使用redis计数器的。热点账户的识别因为比较具象，所以比热点事情的识别相比来说要容易很多。我这里介绍一个通过大数据平台来识别的方式。通过Spark Streaming的窗口计算(window computations)的功能，分析实时计算当前窗口账户的操作次数，最终发现热点账户key，把热点账户key上报给配置中心，再从配置中心下发给各个客户端，来实现热点账户的识别与处理的自动化（图10）。

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/10.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图10</em>
	</p>
</p>

如图， 我们通过读取账务数据库的日志，在spark中对账务的请求按时间窗口实时统计，如果在窗口计算中达到设定的热点账户阈值，就将该账户上报给配置中心。配置中心将配置变更下发给客户端，然后客户端主动缓存热点账户的配置。当应用逻辑执行的时候，通过热点账户的判断逻辑，选择执行不同的应用程序分支。

## 总结
最后我来总结一下。今天首先介绍了热点账户的成因，顺带说了下支付机构的账户体系模型以及热点账户的分类，最后着重介绍了解决热点账户的几种常用的处理方案。

解决热点账户围绕的核心就是怎么最大限度的去减少对稀有资源的争用。每种减少的方式都有它的优势和缺陷，在热点账户的解决上，也没有银弹。在实操过程中都需要按照业务场景以及账户的类型去权衡。

最后我们通过思维导图来梳理一下今天的知识点，让你对热点账户的解决方式有一个更直观的认识。（图11）

<p align="center">
	<img src="https://unionstars.github.io//assets/images/pictures/2020-02-20-hot_account/11.png?style=centerme" alt="Sample"  width="50%" height="50%">
	<p align="center">
		<em>图11</em>
	</p>
</p>