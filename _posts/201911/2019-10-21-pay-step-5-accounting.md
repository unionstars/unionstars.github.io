---
layout: post
title:  "支付系统-账务"
date:   2018-07-11 12:00:00

categories: mysql
tags: index mysql database
author: "XueGang Zhang"
image: /images/logo.png
comments: true
published: true
---

#### 前置学习

`在开发和维护账务系统前，务必请学习以下会计基础知识。`

`会计主体`

定义：会计工作为之服务的特定单位或组织 ，又称会计个体或会计实体 。

`分类：`

| 名称       | 解释                                                                                  |
| ---------- | ------------------------------------------------------------------------------------- |
| 资产       | 是指过去的交易 、事项形成并由企业拥有或控制的资源 ，该资源预期会给企业带来经济利益 。 |
| 负债       | 是指过去的交易或事项形成的现时义务 ，履行该义务预期会导致经济利益流出企业 。          |
| 所有者权益 | 是指所有者在企业资产中享有的经济利益 ，其金额为资产减去负债后的余额 。                |


**账户**

定义：根据所设置的会计科目开设具有一定结构 、能够记录经济业务内容的增减变动情况及其结果。

组成：账户的名称和账户的方向，账户方向即资产、负债或所有者权益。


**帐套**

定义：记载一个独立核算的经济实体的所有往来信息的一整套记录表和统计分析报表统称为一个帐套。

说明：帐套间独立核算、互不影响（建立、删除或修改一个帐套中的数据，不会对其他帐套有任何影响），例如人民币账套、小金库账套。

定义：记载一个独立核算的经济实体的所有往来信息的一整套记录表和统计分析报表统称为一个帐套。

说明：帐套间独立核算、互不影响（建立、删除或修改一个帐套中的数据，不会对其他帐套有任何影响），例如人民币账套、小金库账套。

**会计凭证**

定义：会计凭证是记录经济业务 ，明确经济责任的书面证明 ，是登记会计账簿的依据 。

原始凭证-俗称单据，是在经济业务发生或完成时取得或填制的，用以记录、证明经济业务已经发生或完成的书面证据，是进行会计核算的原始依据。

记账凭证-是会计人员根据审核后的原始凭证的经济内容确定会计分录而编制的一种凭证，是直接登账的依据。

会计分录-是表明记账凭证中应借应贷的账户与金额，是记账凭证的最简化形式。


**复式记帐法**

定义：所谓复式记账法 ，就是对于每一项经济业务 ，都要以相等的金额同时在两个或两个以上的账户中相互联系地进行登记的一种记账方法 。

说明：

必须至少有两个账户
必须同时在不同账户上记录
有记录借的账户，必然有记录贷的账户

**账户余额方向**

| 账户类型         | 借方 | 贷方 | 备注                   |
| ---------------- | ---- | ---- | ---------------------- |
| 资产类账户       | +    | -    | 坏帐准备等抵减科目相反 |
| 负债类账户       | -    | +    |                        |
| 所有者权益类账户 | -    | +    |                        |
| 成本类类账户     | +    | -    |                        |
| 收入类账户       | -    | +    |                        |
| 费用类账户       | +    | -    |                        |

#### 系统概述

账务系统做为支付系统的基础设施之一，为前方的各交易提供底层支撑。所有的支付业务最终都会操作到账户，账务系统即为这些业务提供账户余额变动的记录，流水明细的记录，记账凭证的生成等，使每一笔交易都有迹可寻。

从会员感观的角度，账户是会员能从网银钱包个人站能看到的虚拟账户，会员能直接读取此虚拟账户目前的资金构成及资金变动记录。

账务系统提供了开户、账户基本信息查询（包括查询余额、账户状态等），账户流水查询等功能接口；

从交易层面，账务系统提供了入款、出款、转账、资金冻结解冻等接口；

从账户管理层面，提供了账户的冻结解冻接口（针对账户本身，而非账户的部分资金的冻结解冻）

#### 用户用例

用户：所有业务的正常发起流程，如充值申请、提现申请、转账申请、小金库转入申请、小金库转出申请等，均视为用户调用。

系统：包括业务的异常或分支流程（如充值补单、提现失败退票、转账的被收款方、小金库转入失败退回余额等）、后台及风控发起的指令（如CCMIS后台、风控后台、风控反洗钱系统的异步通知等），均视为系统调用。

#### 名词解释

`账户信息：`

账户是账务系统的基本单位，账户的基本属性包括资金构成、账户状态等。

在进行任何资金相关的业务操作前，必须先在账务系统开户。在三代账户系统中，账户必隶属于会员，而一个会员可以有多个类型的账户，最常用的为基本户，若有基金业务操作，还可开通基金户等。

`账户号构成规则：`
账户号（24位） =  会员号（18位） + [2位账套编号] + [4位账户子类别]

`账套号：`
00 人民币支付账套
01 人民币理财账套

`账户子类型：`

| 会员类型                               | 账户子类型              | 名词解释                                                                                                                                                                                         |
| -------------------------------------- | ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 00个人会员账户                         | 0001基本账户            | 个人的基本账户，用于充提转和消费                                                                                                                                                                 |
| 00个人会员账户                         | 0003理财账户            | 理财户作为一个中间通道，个人使用理财产品时，无论是关于小金库，还是基金，都会通过理财账户透传，例如小金库账户的出款入款都需要透传理财户，目的是作为唯一中间通道起到监控和记录流水等统计数据的作用 |
| 00个人会员账户                         | 0009小金库专户          | 转入可以使用银行卡或者个人基本账户；可以转出到个人基本户，也可以直接转出到银行账户。用户将钱存入小金库获取较高的收益。若个人用户购买基金可以使用小金库的余额购买，而不能使用基本户的余额购买。   |
| 08公司会员账户                         | 0801基本账户            | 企业的基本账户，用于充提转和消费                                                                                                                                                                 |
| 08公司会员账户                         | 0803理财账户            | 理财户作为一个中间通道，企业使用理财产品时，无论是关于小金库，还是基金，都会通过理财账户透传，例如小金库账户的出款入款都需要透传理财户，目的是作为唯一中间通道起到监控和统计数据的作用           |
| 08公司会员账户                         | 0805保证金户            | 预留                                                                                                                                                                                             |
| 08公司会员账户                         | 0807押金账户            | 预留                                                                                                                                                                                             |
| 08公司会员账户                         | 0808欠款账户            | 小金库对应了两家基金公司，个人用户在从小金库转出到基本户时，公司先垫资到个人用户的基本户（因为他可能立即提现），所以企业的欠款需要一个账户来记录就是欠款账户。                                   |
| 80银行类内部账户                       | 8000备付金银行存款      | 对应公司在银行的账户，公司事先在银行存入准备金，待以后支付使用，而公司必须有一个账户来记录相关信息就是备付金账户                                                                                 |
| 80银行类内部账户                       | 8001银行应付账户        | 公司应该在银行卡中扣减一笔款项，而这笔金额就记录在银行应付账户中                                                                                                                                 |
| 80银行类内部账户                       | 8002银行应收账户        | 公司应该在银行卡中增加一笔收入，而这笔收入就记录在银行应收账户中                                                                                                                                 |
| 80银行类内部账户                       | 8003银行实收账户        | 记录银行实际收入的账户                                                                                                                                                                           |
| 80银行类内部账户                       | 8004银行实付账户        | 记录银行实际支付的账户                                                                                                                                                                           |
| 80银行类内部账户                       | 8005银行收入待查        | 预留                                                                                                                                                                                             |
| 80银行类内部账户                       | 8006银行支出待查        | 预留                                                                                                                                                                                             |
| 80银行类内部账户                       | 8010自有资金银行往来    | 预留                                                                                                                                                                                             |
| 88共同类内部账户（360880000000000005） | 8801收单待清算          | （下面一系列&#39;待&#39;账户作为中间过渡账户，发生在记账过程中）                                                                                                                                 |
| 88共同类内部账户（360880000000000005） | 8803付款待处理          | 公司需要支付的款项，不是立刻支付，而是一般两小时内支付                                                                                                                                           |
| 88共同类内部账户（360880000000000005） | 8805退款待处理          |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8807付款待核对          |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8809退款待核对          |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8811拒付应付款          |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8813担保应付款          |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8815银行收入待查        |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8800充值待核对          |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8802收单支付待核对      |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8804付款退票待核对      |                                                                                                                                                                                                  |
| 88共同类内部账户（360880000000000005） | 8816银行支出待查        |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8850 收单交易手续费收入 | （下面一系列手续费、利息等相关账户）                                                                                                                                                             |
| 88损益类内部账户（360880000000000005） | 8852会员充值手续费收入  |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8854会员转账手续费收入  |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8856会员提现手续费收入  |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8858代付手续费收入      |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8859代付手续费支出      |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8860备付金户利息收入    |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8862自有户利息收入      |                                                                                                                                                                                                  |
| 88损益类内部账户（360880000000000005） | 8864账户管理费支出      |                                                                                                                                                                                                  |
`账户与资金渠道：`
机构编码(fundChannelCode)和机构商户号 (instMerchantId)和会员一一对应。

`五个资金渠道关联账户：`

8000，银行备付金存款

8001，银行交易应付账户

8002，银行交易应收账户

8003，银行资金应付账户

8004，银行资金应收账户

`账户资金：`
账户总金额为账户的余额，冻结金额为账户余额中的不可用部分，充值风险金为兼容老账务系统中账户余额中充值入款的部分，账户金额构成见下图 。

`资金分为四种：`

总余额：用户拥有的所有余额。
冻结余额：因业务需要冻结掉的余额
风险余额：目前特指充值风险金，不可用于提现出款操作。
可用余额：总余额-冻结余额-风险余额
     可用余额 = 总余额 – 冻结余额 – 风险余额
     一般前端显示的金额为可用余额。


#### 账户状态

1.   账户有三种状态：冻结、正常、关闭。
      冻结状态的账户不能进行客户层面或系统层面的入款或出款操作。
      关闭状态的账户不能进行任何资金出入操作。 

2.  四种冻结标记（禁止客户发起的入款、禁止客户发起的出款、禁止系统发起的出款、禁止系统发起的入款），发起冻结时需指定冻结模式为上述四种之一，或上述四种的部分组合模式。
     其中规则如下：系统级别的操作大于客户级别的操作。即，当禁止了系统级别的出/入款操作，必须禁止客户级别的出/入款操作。
     下表中黄色高亮部分的组合模式均不允许发起。

| 冻结模式 | 对应的状态 | 客户发起的入款1 | 客户发起的出款2 | 系统发起的出款4 | 系统发起的入款8 |
| -------- | ---------- | --------------- | --------------- | --------------- | --------------- |
| 0001     | 1          | 禁止            | 允许            | 允许            | 允许            |
| 0010     | 2          | 允许            | 禁止            | 允许            | 允许            |
| 0011     | 3          | 禁止            | 禁止            | 允许            | 允许            |
| 0100     | 4          | 允许            | 允许            | 禁止            | 允许            |
| 0101     | 5          | 禁止            | 允许            | 禁止            | 允许            |
| 0110     | 6          | 允许            | 禁止            | 禁止            | 允许            |
| 0111     | 7          | 禁止            | 禁止            | 禁止            | 允许            |
| 1000     | 8          | 允许            | 允许            | 允许            | 禁止            |
| 1001     | 9          | 禁止            | 允许            | 允许            | 禁止            |
| 1010     | 10         | 允许            | 禁止            | 允许            | 禁止            |
| 1011     | 11         | 禁止            | 禁止            | 允许            | 禁止            |
| 1100     | 12         | 允许            | 允许            | 禁止            | 禁止            |
| 1101     | 13         | 禁止            | 允许            | 禁止            | 禁止            |
| 1110     | 14         | 允许            | 禁止            | 禁止            | 禁止            |
| 1111     | 15         | 禁止            | 禁止            | 禁止            | 禁止            |

冻结：只能针对非关闭状态的账户进行此操作，且需指明冻结模式为上表中的八种组合模式之一。对账户发起冻结请求后，将账户状态位改为冻结，计算账户已有的冻结模式与传入的操作后的结果，将此结果记录在账户的冻结模式位；

解冻：解冻不与原冻结操作相关联，调用方指定要解冻的模式，即指定解冻以上四个模式位中的某一位或某几位。如指定解冻客户入款位，操作成功后，该账户允许客户级别的入款。若解冻的模式位当前并未冻结，返回成功和相应的提示。


`冻结金额变更：`
资金冻结解冻分两种模式：

`流水校验模式：`
解冻时调用方需传入原冻结单号，解冻的金额需小于或等于原冻结单的金额，若传入的金额小于原冻结单的冻结金额，可以再次针对此原冻结单发起解冻，直至原单的冻结金额全部解冻完毕。即 0 < 解冻金额 < 原冻结单冻结金额 - 针对此单已解冻的金额。

`资金池校验模式：`
发起资金冻结的时候在账户内部形成了一个资金池，解冻时只允许解冻此资金池中的冻结金额。如果业务A冻结的资金，允许B业务来解冻，业务方需说明，即A,B业务共用一个资金池。只要资金池里的冻结金额>=解冻金额>0，则允许解冻。

`说明：`

冻结时即需指定模式，流水模式的冻结只能用流水模式解冻，资金池模式的冻结只能用资金池模式解冻。一个账户所有流水模式的冻结金额与所有资金池模式的冻结金额之和等于该账户的冻结金额。

为了保证所有的资金可追溯，账务系统不提供不做任何校验的解冻接口，即不允许既不指定原冻结单号也不指定资金池的解冻。

账务系统提供查询某账户下所有资金冻结条目，包括流水模式的冻结条目和资金池模式的冻结条目。后台运营系统可通过查询接口选择要解冻的原单。

账户的冻结模式与资金的冻结模式无关，即若一个账户处于冻结状态（冻结止入或冻结止出或完全冻结），依然允许对此账户执行资金冻结解冻的操作。

#### 业务说明

时效性
用户的操作，在不与资金渠道打交道的地方和场景中，即我方支付系统内部时，都是立即到账；当涉及到银行资金渠道时，充是即时到账，提是我方保证两小时内到账。

基本户的充提转
充：在充值过程中，假设用户使用中国银行的银行卡充值0.5元到京东钱包，用户的银行卡扣减0.5元，钱包账户增加0.5元。然后接下来分两端说明：

在银行端，公司会提前在每个银行开一个账户，用户的钱会从他的银行卡转到支付公司的银行卡（一段时间统一结算，不是实时到账）；

在支付系统端，内部有两个账户，一个是个人用户的基本户，它增加0.5元，表示用户充值成功，后续可用于消费，另一个是银行应收账户，它增加0.5元，表示公司在银行的银行卡应增加的收入。

提：在提款过程中，假设用户提现0.5元到中国银行卡，用户的基本账户扣减0.5元，用户的银行卡增加0.5元（两小时内到账）。

用户提现时，除了用户的基本户会减少0.5元，表示扣款成功，付款待处理户会增加0.5元，表示需要支付用户0.5元。

转：转账的通道是通过个人基本户，用户A向用户B转账，这是应用场景。

所以银行卡里的钱首先得充值到个人基本户，再转账给别人；小金库里面的钱，首先得转到个人基本户，再转账给别人。

小金库账户的转入转出
转入：小金库的转入可以选择从个人基本户转入或者直接从银行卡转入，但是无论是哪一种方式，都必须通过理财账户透传。

转出：小金库的转出可以选择转出到个人基本户或者直接转出到银行卡，但是无论是哪一种方式，都必须通过理财账户透传。