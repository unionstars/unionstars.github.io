---
layout: post
title:  "识别微服务的领域模型边界"
date:   2019-04-12 12:00:00

categories: java
tags: DDD
author: "张学刚"
---


> 在大型商业系统中，为了系统的性能考虑和高扩展性，都以积木方式构建，大多以微服务形式存在，但是如何划分积木，如何定义每个微服务的边界，这可能是每个人都会遇到的一个挑战。每个微服务必须成为应用的一部分，并且每个微服务必须是自治的，这是一种优势和并存的情况。那么要如何定义边界？

> 首先需要关注的是应用的逻辑领域模型和相关数据。必须尝试识别同一个应用中解耦后的数据孤岛和不同的上下文，而每个上下文可以用不同的商业语言，上下文的定义和管理应该独立进行，在不同上下文中使用的术语和实体可能听起来相似，但有时在特定上下文中的一个业务概念在另一 个上下文中可能会被用于不同的目，甚至可能使用不同名称。例如，同一个“用户”，可以是身份或会 员系统上下文中的“用户”，是 CRM 中的“客户”，甚至还是订单上下文中的“买方”等

> 识别多个应用上下文以及每个上下文所对应不同领域之间的边界的方式，也能用来识别每个业务微服务、相关领域模型以及数据的边界，我们需要尽可能的降低这些微服务之间的耦合。


### **微服务的拆分原则**

虽然微服务应该尽可能地趋向于小型化，但识别每个微服务的模型边界不是为了尽可能拆成细粒度，而 是根据领域知识来进行最有意义的划分。重点不在于大小，而在于业务需要。另外，如果因为存在庞大 复杂的依赖关系而要求应用的某个领域有清晰一致的需求，这也就表明该领域应该是一个独立的微服 务。“一致”这个特点是用来识别如何拆分或组合微服务的方法之一。本质上，当我们对相关领域的了解越深入，就应该越能够适配微服务的大小。找到正确的大小，这个目标无法一蹴而就。

这一点非常重要，对相关领域的了解越深入，就越能找到合理的大小，这也是为什么对于业务系统开发的资深专家，需要很强的业务知识，因为系统划分的合理性，以及未来的拓展性，很大程度上是你对业务的熟悉度以及对未来领域前瞻性的把控。

Sam Newman 是公认的微服务布道师，同时也是《微服务设计》一书的作者，他强调应该基于限界上下文(BC)模式(领域驱动设计的一部分)来设计微服务。有时候，一个BC能够由多个物理服务组成，反之则未必。

最终确定的 BC 或微服务中需要具备包含特定领域实体的领域模型。BC 界定了领域模型的适用性，借此开发团队成员可以清晰地理解哪些内容必须结合，哪些可以独立开发，并共享知识。微服务的目标正是如此。

另一个会影响设计决策的工具是康威定律，该定律认为，应用程序本身体现了创造这个应用的企业本身 的组织架构。有时候反过来理解也是正确的:公司的组织架构应围绕软件来组成。您也许想逆康威定律 而行，按照自己的想法构建公司的组织架构，那就必须学习业务流程咨询。
上下文映射模式是一种 DDD 模式，可以用来识别限界上下文。借此，我们可以识别应用中不同上下文 和它们的边界。现实中通常每个子系统有不同的上下文和边界。上下文映射是一种明确并定义领域之间 边界的方式。BC 是自治的，包含了一个领域中的各种细节，例如领域实体，并定义了与其他 BC 的交 互接口。这与微服务的定义十分相似:是自治的，实现了特定的领域功能，必须提供接口。因此上下文 映射和限界上下文模式是用来识别微服务的领域模型边界的好方法。

在设计大型应用时，我们会看到它的领域模型是如何拆得支离破碎，例如产品领域的专家和物流领域的 专家会给产品和库存领域的实体进行不同的命名。再例如一个想把客户所有细节都保存下来的 CRM 专 家和一个只想要客户部分数据的订单领域专家，在处理用户领域实体时会有不同的大小和字段数量。有 时候我们很难消除大型应用里所有领域术语之间的歧义，但重点不在于试图统一术语，而在于接纳每个 领域的差异和多样性。如果想要为整个应用建立统一的数据库，企图达到统一词汇的目的，这样的做法 本身就会让人感觉奇怪，并且对任何领域专家都是不合适的。因此，BC(以微服务实现)会帮助澄清 哪里需要特定的领域术语，以及哪里需要把系统拆分成额外的不同领域 BC。
如果在领域模型之间有少量强关联，我们就可以确定每个 BC 和领域模型已经具备恰当的边界和大小。 当进行常规应用操作时，我们通常不需要整合多个领域模型的信息。

每个微服务的领域模型到底该有多大?这个问题的最佳答案也许是这样的:应该有一个尽可能独立的自 治 BC，使得我们无需不断在其他上下文(其他微服务模型)之间切换。如图 4-10 所示，多个微服务 (多个 BC)有自己的领域模型，从中可以看出实体的定义方式，具体方法主要取决于应用中每一个识 别出来的领域所具有的特定需求。



### **识别每个微服务或限界上下文的领域模型**

![识别每个微服务或限界上下文的领域模型](https://raw.githubusercontent.com/unionstars/unionstars.github.io/master/assets/images/pictures/2019-04-12-ddd/01-01.png)

 
上图演示了与联机会议管理系统相关的示例方案。 已经根据域专家定义的域确定了几个可作为微服务实现的 BC。 如你所见，有些实体只存在于单个微服务模型中，比如付款微服务中的付款。 这些将易于实现。

但是，也可能有一些实体具有不同的形状，但在来自多个微服务的多个域模型中共享相同标识。 例如，在会议管理微服务中标识用户实体。 具有相同标识的相同用户在订购微服务中名为“购买者”或在付款微服务中名为“付款者”，甚至在客户服务微服务中名为“客户”。 这是因为，具体取决于每个域专家使用的通用语言，用户可能有不同的视角，甚至具有不同的属性。 名为“会议管理”的微服务模型中的用户实体可能具有其大部分个人数据属性。 但是，在微服务支付中以“付款者”形式或者在微服务客户服务中以“客户”形式的相同用户可能不需要相同的属性列表。

下图展示了另一种类似的方法

![传统数据模型分解为多个领域模型](https://raw.githubusercontent.com/unionstars/unionstars.github.io/master/assets/images/pictures/2019-04-12-ddd/01-02.png)


可以看到用户是如何作为用户实体出现在会议管理微服务模型中的，并且在定价微服务中也以购买者实体的形式出现，当用户实际上是购买者时，具有备用属性或用户详细信息。 每个微服务或 BC 可能不需要与用户实体相关的所有数据，而只是其中的一部分，具体取决于要解决的问题或上下文。 例如，在定价微服务模型中，不需要用户的地址或名称，只需 ID（作为标识）和状态，这将影响在为每个购买者的席位定价时的折扣。

在每个域模型中，席位实体的名称都相同，但属性不同。 然而，席位共享具有相同 ID 的标识，就像用户和购买者一样。

基本上，在多个服务（域）中存在用户的共享概念，都共享该用户的标识。 但在每个域模型中，可能存在有关该用户实体的其他或不同的详细信息。 因此，需要有一种方法将用户实体从一个域（微服务）映射到另一个域。

不与相同的属性数目跨域共享相同的用户实体有几个好处。 一个好处是减少重复项，以便微服务模型没有不需要的任何数据。 另一个好处是拥有一个主微服务，它拥有每个实体的特定类型的数据，以便对该类型数据的更新和查询只能由该微服务驱动。
