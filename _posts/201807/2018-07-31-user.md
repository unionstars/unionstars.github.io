---
layout: post
title:  "电商系统的奠基石-账号服务架构"
date:   2018-07-11 12:00:00

categories: java
tags: 用户
author: "穆永俊"
---

> 账号系统维护和管理所有客户的基础信息，维系主账号与第三方账号的授信关系。基于这些用户信息和账号授信关系，提供一套标准且统一的登录认证系统、账号注册系统、账号风险鉴定和消除、账号会话管理服务以及账号信息查询和维护服务。账号系统是整个电商生态系统中最基础的一环，其稳定性、可靠性以及安全性对客户的购物体验至关重要而且不可忽缺。接下来，我会详细的从统一登录认证、账号风险鉴别和消除、用户信息查询和维护三个方面与大家一起探讨我们账号体系架构和规划。

![账号系统](https://raw.githubusercontent.com/unionall/unionall.github.io/master/assets/images/pictures/2018-07-31-user/01-01.png)

账号系统是一个数据型服务系统，建立在用户的账号基础信息、账号与第三方账号关联关系、账号风险库等数据之上。基于这些数据构建和提供相应的服务和应用，任何服务的访问会进行统一鉴权。

### **统一认证**

统一登录认证主要职责是鉴定用户身份，根据用户提供的有效的认证信息，颁发相应的登录凭证。当用户访问任何业务系统时，需要携带该凭证。业务系统在执行相关业务逻辑之前，统一将登录凭证发送给登录会话管理服务进行验证，登录会话管理服务负责验证登录凭证的合法性。当登录凭证不合法时，登录会话管理服务会清除当前凭证对应的session记录，同时在反馈给业务系统的响应结果中，会要求业务系统清除无效的登录凭证，同时引导用户到统一登录认证系统重新进行身份验证。

交互流程图：

![账号系统](https://raw.githubusercontent.com/unionall/unionall.github.io/master/assets/images/pictures/2018-07-31-user/01-02.png)

整个登录认证流程中，涉及到业务系统、统一登录系统、集中式session三个部分。统一登录系统调用集中式session提供的写服务，完成session的创建和存储；业务系统调用集中式session提供的读服务，完成session的有效性和合法性检查。统一登录系统在调用集中式session写服务之前，要从账号、IP、设备三个维度对登录操作进行判断。账号维度的判断，包括登录入口是否有效、账号是否被锁定、账号是否在异地操作、是否使用常用设备登录、账号是否为机注账号等，一旦有任何异常情形，进行实时拦截；IP维度主要对同一IP不同账号登录进行统计，识别是否存在撞库嫌疑并根据实际情形，提高验证门槛；设备信息用来鉴别登录操作使用的设备是否真实有效，对同一设备上登录的账号进行实时统计，满足风险规则后，对该设备上账号登录操作增强验证机制，补充用户真实有效的身份信息。对用户身份信息增强验证，包括语音消息验证、图形滑动验证码、银行卡绑定、实名认证等。

接下来主要是登录系统的架构（主要介绍PC端，其他端类似），分四个层次：客户层、应用层、服务层、存储层。客户层负责用户登录视图的展示逻辑控制，根据接入登录的业务系统需求，会有多种不同的登录视图，包括：广告登录页、弹出层登录页、业务方内联嵌入式登录页、扫码登录页，同时会在客户层埋点生物探针，用来进行人机分析数据采集和上报。应用层即统一登录WEB应用 passport..com，主要负责客户端层视图渲染、登录流程中转和控制、恶意请求清洗和过滤。服务层即用户中间件层，主要功能是提供标准的针对所有终端和渠道的用户身份信息验证服务，用户账号注册服务，用户信息查询和维护服务，登录系统会涉及用户身份信息验证服务和用户信息查询服务的调用以及集中式session服务和风险账号识别服务的封装和适配转换。存储层即存储用户的身份信息、基础信息、扩展信息、最后登录日志等，对于下游系统对登录的感知通过登录消息进行解耦。

![账号系统](https://raw.githubusercontent.com/unionall/unionall.github.io/master/assets/images/pictures/2018-07-31-user/01-03.png)

### **账号风险鉴别和消除**

账号风险鉴别主要针对机注账号、黄牛账号、刷单账号、刷券账号、撞库账号等进行识别，根据识别结果踢出相应账号在各端登录态，对账号的风险级别进行后续相应的限制。限制手段包括：锁定账号、加入货到付款黑名单、滑块或者点选图形验证、手机语音验证、绑定银行卡、实名验证等。

![账号系统](https://raw.githubusercontent.com/unionall/unionall.github.io/master/assets/images/pictures/2018-07-31-user/01-05.png)

主要分四个部分：
风控合规服务：调用风控研发团队的风控服务，获取账号的风险类型；
安全合规服务：信息安全内部账号风险鉴定服务，主要识别账号是否存在撞库风险；
常用地址服务：基础账号记录账号常用的下单地址和注册地址，防止账号被盗异地下单；
机注账号识别：根据生物探针采集到的行为数据，识别出机注账号，对该类账号进行加验挑战。统一账号风险鉴定服务综合以上四个服务的响应结果，进行决策，从短信验证码、滑块和点选图形验证、语音验证、银行卡绑定、实名验证中匹配最优的验证方式。这个验证方式选择是根据账号实际触发的风险类别进行确定。比如机注账号，只会从语音验证、滑块和点选图形验证中抉择。黄牛账号会涉及银行卡绑定、实名验证或者结合手机绑定、语音验证多个手段综合验证，具体账号要根据账号的情形进行确定。

账号登录态的踢出，会有两种情况：一、主动踢出。即用户调用修改密码接口时，会调用统一登录会话管理服务清理PC端该账号所有登录session记录，同时发送密码修改MQ消息，APP、M站、微信购物、QQ购物、京麦平台等独立维护登录会话的系统会接受修改密码消息，然后清除本端该账号的登录session记录；二、被动踢出。经过风控或者信息安全合规系统实时分析，发现有账号存在被盗用风险，调用统一登录会话管理服务清理PC端该账号登录session，同时发送给各端登录态踢出MQ消息，各端接受消息后清理本端登录session记录，同时调用账号锁定服务，将该账号进行锁定。

### **账号信息查询和维护**

用户成功登陆之后，跟账号系统的交互便只剩下查询用户的个人信息，例如头像、昵称、会员PLUS状态、用户类型等。用户信息查询和维护服务，归属于用户服务中间件。用户服务中间件主要提供根据账号名、账号关联手机号、账号关联邮箱等对用户基础信息、扩展信息进行查询和维护

由于查询用户信息的系统和应用非常多，需要对所有调用方进行规划和治理。根据调用方业务的访问量和重要程度进行隔离服务，交易核心业务：订单、秒杀、优惠券、移动交易、微信手Q交易等提供独立的应用分组和独立的数据缓存；非核心的或者访问量小的其他业务系统共享应用分组和数据缓存，然后由用户数据同步worker完成两个缓存集群数据的校验和同步。

![账号系统](https://raw.githubusercontent.com/unionall/unionall.github.io/master/assets/images/pictures/2018-07-31-user/01-04.png)

为保障系统的高可用性，在访问用户信息缓存和数据库时，充分利用冗余的多套从库，进行负载均衡，以及故障转移。由于篇幅有限，此处不再详述。任何调用方访问用户服务中间件之前，均需要授权。申请人需要在账号服务自助申请后台提交相关接口和方法的申请，说明调用方应用和负责人，各个时间维度的调用阈值，待基础账号部门产品运营人员审核后，调用方才具备访问权限。通过调用方提供的各个时间维度的阈值，基础用户服务中间件进行访问限流。

### **问题答疑**

```用户信息是怎么存储的，用哪个字段作为分表健。比如用用户名的话，那如果我用手机号登录，是怎么查询到我的信息的```

以pin hash存的, 有另外一张索引表,这个索引表是手机号hash存的, 可以查到pin.
