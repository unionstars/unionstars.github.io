---
layout: post
title:  "拉平周期保底费用计算系统"
date:   2018-07-11 12:00:00

categories: Java
tags: learningnote
author: "张学刚"
---

# 拉平周期保底费用计算系统

## 名词解释

1. 拉平周期：联营商保底费用缴纳周期
2. 拉平周期保底费用单：拉平周期内所有费用实时累加、拉平周期结束时，关闭单据，计算保底费用

## 拉平周期保底费用计算业务描述

该金额的计算规则为拉平周期内所有佣金汇总，如果汇总金额大于固定费用，按佣金收取，如果佣金小于固定费用，用固定费用-佣金计算出，差额，然后将差额作为一种费用推送给结算系统，进行补差。

## 方案一

### 核心业务交互逻辑描述

1. 按账户和门店维度创建拉平周期保底费用单
2. 接收结算系统费用明细消息，保存明细、并实时累加拉平周期保底费用单金额
3. 拉平周期结束，关闭单据，比较该拉平周期内汇总金额数，和结算系统汇总金额数是否一致
4. 如果金额相同，按拉平周期和固定佣金的计算规则，计算金额，并推送计算的金额，到结算系统，修改状态为已推送、待结算，等待结算系统回执消息。
5. 金额不同，等待重试，如果超过重试次数，进行告警，人工介入。

### 拉平周期系统交互时序

![拉平周期系统交互时序](https://raw.githubusercontent.com/unionstars/unionstars.github.io/master/assets/images/pictures/2018-08-22-settle-period/01-01.png)

## 优缺点

1. 只保证了结算系统与拉平周期保底费用计算系统的数据一致性，并不能保证和订单系统的一致性

2. 需要以结算系统为依据对账，如果结算系统数据没有过来导致拉平周期费用与结算系统费用对不上时，需要等待结算系统推送

## 再回到需求

1. 商家是感知佣金费用的，页面最好用户能实时感知，拉平周期内待付的佣金、待结算的金额、固定费用（用户钱包）
2. 可以到处拉平周期内待付佣金的明细

## 还有没有更好的方案?

1. 结算明细按日入账、拉平周期结算和结算周期结算，都以日账单为为基准按拉平周期和结算周期进行汇总结算

优点：



## 表结构的设计
1. 商家拉平周期的佣金汇总单
2. 商家拉平周期的佣金明细



<!-- ```bash
@startuml
拉平周期保底费用计算系统-[#red]> 拉平周期保底费用计算系统 : 按账户与门店创建拉平周期保底费用单
结算系统 -[#red]> 消息中间件 : 结算单据佣金费用明细
消息中间件 -[#red]> 拉平周期保底费用计算系统 : 拉取结算单据佣金费用明细
拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统 : 1. 数据有效性验证
拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统 : 2. 保存单据佣金费用明细(待通知结算)\n3. 拉平周期保底费用单\n[以上都在一个事务中进行，使用]
拉平周期保底费用计算系统 -[#red]>  结算系统 : 1. 更新结算系统通知状态(RPC)\n2. 更新单据费用明细状态（已通知结算）
拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 1. 关闭该拉平周期单据\n2. 按账户与门店维度统计拉平周期费用金额，与单数
拉平周期保底费用计算系统 -[#red]>  结算系统 : 按账户和门店获取结算系统拉平周期佣金费用总额，与订单数
结算系统--[#red]>  拉平周期保底费用计算系统 : 按账户和门店返回结算系统拉平周期佣金费用总额，与订单数
拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 对比结算系统与拉平周期保底费用计算系统的金额，与订单数
拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 数据匹配
 alt 数据匹配成功
    拉平周期保底费用计算系统 -[#red]> 商家系统: 获取商家固定费用
    拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 计算应收费用
    拉平周期保底费用计算系统 -[#red]>  结算系统 : 推送计算的拉平周期费用(RPC)
    结算系统 --[#red]>  拉平周期保底费用计算系统 : 返回拉平周期费用接收结果(RPC)
    拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 核销账户拉平周期单据(RPC)
  else 数据匹配失败
    拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统: 等待重试
    拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统: 告警、人工处理
end

对账系统 -[#red]> 对账系统: 考虑引入？
@enduml
``` -->