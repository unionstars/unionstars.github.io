---
layout: post
title:  "对系统建设的思考"
date:   2018-07-11 12:00:00

categories: Java
tags: learningnote
author: "张学刚"
---

# A/B转账的问题

## 适用的场景

转账并不需要要实时到款的场景，这个方案主要是通过异步化的方式，最大的提高系统的吞吐量。

## 存在的缺点

存在延时

## 最终一致性的保证

- 如果A扣款成功之后，消息没有发送出去，需要依赖日志/任务表，通过消息发送状态进行扣款消息的重发
  
- 如果消息发出去之后，没有接受到B系统消费成功的最终态不断的重发,高频的work可以查询从库。

- B系统要做好幂等和防重处理，MQ会重复投递

## 当前存在的问题

- sequence主键生成，可以使用sequence表进行累加，每次放出一些放在缓存中
  
- 要增加补偿次数，次数超过几次之后进行告警，人工干预
  
- 锁也可以修改为分布式锁，防止并发，按以往的经验来说如果redis稳定，问题也不是很大
  
- 消息要放在事务外边
  
- 安全性上，可以用公钥、私钥，以及证书的方式，更大的提高安全性

- 这个地方是以A系统为基准进行对账，不过对账是个计算密集型的服务，是否可以单独剥离出来，对两系统的双边账务，引入对账系统进行，对账，然后对对账的不同状态进行自动化处理，再比如接收A成功的消息，和B成功的消息，对数据进行校对，正反操作都有，则成功，以后可以根据对账的表，进行具体的失败分析。来调度A系统和B系统

- 是不是还可以进行余额验证，等有效性验证完成之后，把消息先存起来，然后异步的扣款和加款。

## 有没有其他分布式的解决方案

- 从转账这个需求来说，TCC的用户体验更好，吞吐量的话，相比异步确保会小一些。

- 两阶段，比如我们拆分了数据库，但是应用还是一个应用的时候可以用XA协议，两阶段提交的方式进行分布式事务的控制，这样比较简单。

- TCC，后来如果我们开始拆分为服务接口，提供的是soa的服务接口，比如dubbo，这个时候如果是强事务，我们可以使用tcc事务，如果遵循这种TCC规范的话，服务端要实现try,confirm,cancel接口，TCC和核心理念是在prepare阶段做尽可能多的事情，confirm阶段是一个尽可能轻量的工作，Tcc的唯一问题在，confirm阶段出现问题的时候，数据不一致，但是这一般是一个比较轻量的动作，一般很少出问题，极端情况下，如果出现问题，也可以通过补偿的方式解决。

- 异步确保，异步确保的话，实时性没有那么高，但是可以实现最终的一致性。

# 金算盘系统

## 系统划分

- 账户、计费、结算、收付款、票据、账务、风控（计划）

- 系统划分的原则上，我们按业务块进行划分，划分的原则上，主要就是针对高内聚，低耦合的思想原则，还有一个就是，组件进行组合，是不可以可以对外提供完整的服务，比如说，计费是将业务系统的订单，给相关的参与方，进行各种费用的计算（仓储、配送、佣金、货款、优惠、服务费），计算完成的数据，是可以进行结算的一条费用明细。把数据安全的交接给结算系统。

- 结算系统，是可以单独承接业务的，比如我们公司的虚拟订单（机票，酒店、本地生活），是直接将数据推送给结算，让结算系统按照商家与京东合同的约束进行按周期结算的。这个时候账务+结算就可以作为一套整体的方案输出给系统。

- 收付款，是将结算按周期生成的结算单，再按照商家收款的方式（收支两条线，生成收款单和付款单），京东结算机构的不同，生成收付款单据，这个收付款单据，会推送给下游财务系统进行收付，完成后通知我们结果。

- 票据是京东给商家结算的时候，要求商家先把发票寄给京东，然后提交核销申请，结算单所对应的核销费用，核销完毕后，结算单才可以触发生成收付款单。还有一些是需要京东给商家开发票的，需要商家提交发票开票申请，然后京东开具发票并邮寄。

- 账务系统主要是提供商家查询和下载，商家结算费用明细和明细发票开具的情况。

- 风控正在规划中，现在主要是阈值监控、扣点非法监控（临界值）、商家异常结算收入监控，耦合在程序逻辑中。

- 对账系统（针对MQ丢失的情况），可以对单边账务，然后进行自动化的补偿和处理。

- 账户系统是基础，他应对不同的商家，以及导购员、联营商、租户、门店下的联营商，这些作为独立结算主体，还有就是绑定银行卡，一分钱验证等。

## **对账系统**

对账这个地方，我也研究了一下，包括美团的外卖配送团队的对账方案，以及我们的方案做过一些对比，对产出也做过一些对比，我可以介绍一下：

- 体量的对比，拿我们的计费结算系统来说，虚拟的业务通过通用接口推送数据，虚拟有90多种业务，实物的通过订单消息来发送，有30种类，对比美团他们有专送、众包、快送、跑腿、外部单等多条业务线单补贴、活动发放、奖惩、餐损、打赏、保险等多种结算场景；对接外部十多个系统。日订单也是千万级别。

- 对账思路上：美团的对账思路，all in one，所有业务系统的运单数据，都要进入到对账系统，然后进行全链路的核对，核对完成后，进行差错处理，对账系统作为最后一道防护墙,好处是尽量做到，结算数据有没有结算，由结算系统首先感知，但是也有一定的问题。比如他们把进来的数据，放入到对账池，如何保证数据在进入数据池的时候不丢？如何保证数据池里边的数据是全量的，这里我觉得还是很难做到的。 他们通过接口的方式、ETL的方式、MQ的方式，都很难做到，除了主动拉取的方式相比最可靠，其它方式都是由业务系统来决定的。

- 我们的对账思路，分而治之，接口的方式，要求业务系统必须记录，推送状态以及计费系统为订单费用明细产生的计费ID，因为业务系统是数据的产生方，让业务系统保障，数据不露推，后续的结算系统保证，数据不会结错、不重复结。而MQ的方式，MQ本身有重试和ACK处理，如果消息不正常消费，会继续投递，不标记删除，但是，还有一个问题就是，如果消息没有投递到消息中间件怎么办？

- 相同点，实现全流程对账，都是通过binlog进入Kafka进行消费的时候，比如说结算的数据，可以先放在缓存里，然后等发票的数据过来的时候一起落库，只要，长时间在redis的数据可以做一些响应的告警处理，认为是没有及时处理的。处理的时候通过strom进行路由处理。

- 优缺点：all In one还有一个问题，业务接入的时候，相当于接入了一次数据，进入对账池，相当于还要接入一次，开发工作量大，如果做saas化平台，比如计费不好saas化，但是结算很好saas的，如果all in one saas化的对账很难利用对账池进行解决,不可能每个系统都对接两次，分开治理的缺点：有业务系统记录状态，标识自己有没有推送，推送后返回的业务编号，但是这个时候数据有没有推送过来，结算系统是没有感知的，作为一个结算平台来说，问题会首先暴露给你，认为结算系统不可靠。当然这种问题，也可以提供给用户查询接口，但这种方案不完美，依赖于上游系统，来确保最终可靠。

# 计费系统

## 触发条件

订单完成、支付完成

## 计费公式

各费用不一样，如货款=商品总京东价-店铺京券优惠金额-店铺东券优惠金额-满减优惠金额单品-促销优惠金额-套装优惠金额-团购优惠金额-闪团优惠金额-满赠满返促销优惠金额-预售优惠金额-店铺限商品东劵优惠金额-店铺限商品京劵优惠金额-自营FBP联合优惠券
计费参数获取：同一费用各业务使用都不一样

## 关联系统和遇到的问题

计费的上游系统、虚拟业务、团购业务、订单系统、仓储配送系统、赔付系统
计费结算最核心的就是，数据准确、安全、按时。这是项目的问题域，然后我们针对这些东西，技术架构上怎么核心解决这些问题

1. 业务系统发送MQ没有触达，
2. 商家核对账单发现少费用了
3. 未及时付款

## 系统底线

1. 准确是指计费的时候清分的准确、结算付款的时候，数据不丢不重，结算的准确，这就要保证，数据每个环境的一致性
2. 安全就是结算不算错，第二就是对商家刷单的一些监控，扣点设置的一些风控
3. 按时，结算明细和结算单能够按时关单，按时关联，按时结算

## 解决方案

1. 这种我们是大限度的，消息校验后，立马把消息接下来，不做业务逻辑处理，防止MQ可能的异常。

2. 这种可能是因为数据积压导致的业务周期内的订单没有结算到正确的周期内,以各种时间都很难避免

3. 出纳一般手动打款，这个时候，一定时间的我们会轮询去查一下，看看是不是异步付款消息丢失，如果轮询发现，状态未进行付款，则会继续等待

# 结算系统

## 量级

1. 数据库存储： 日均5000万，分32库1024表，大商家按天分表，数据通过ES进行整合。

2. 原样历史数据：归档三个月归档一次，归档到Habse，现在还没有利用起来，线上现在只查三个月内的数据

3. ES宽表数据：ES索引，三个月一个别名，每月一个索引，然后三个月后，归档最后一个月的索引数据到历史别名中

# **如何做异地容灾**

## 当前模式

1、异地容灾。这仅仅是一个冷备的概念。也就是在平时正常的时候，另外一个机房只是当做备份。
2、异地双（多）活。而异地双（多）活，却是指有两个或者多个可以同时对外服务的节点，任意一个点挂了，也可以迅速切换到其他节点对外服务，节点之间的数据做到准实时同步。

“两地三中心” 已经是跨机房灾备的标准技术架构，通常会在相距 40 公里范围以内的同座城市建设灾备数据中心，应对机房级别的故障。之所以将距离锁定在 40 公里范围以内是考虑到这个距离通过高速光纤相连，机房之间的响应延迟一般在 1ms 左右，从业务层面讲可以认为是在同一个局域网内。“两地三中心” 的技术架构最早在银行和金融行业应用实施，但一般都只有一个机房提供服务，其他的灾备机房仅同提供服务的生产机房进行数据复制，这种冷备的模式并不适用于互联网业务：

## 异地多多活的目标

1. 多个跨地域的数据中心：异地的距离1000KM以上的范围，在中国范围内全国城市都可以去布
2. 多点写：每个数据中心都要承担用户的读写流量；
3. 分钟级切换：任意一个数据中心出问题，其他中心都可以分钟级去接管用户的流量。

## 理想的情况

1. 按用户分片，访问不同数据中心，随意切换；
2. 数据中心内的业务，完成自调用闭环；
3. 数据中心无限水平复制。

## 挑战

1. 延时
如1000+km大约30ms的网络延迟，看起来没什么，对用户来讲，如果只是增加30ms，其实基本感受不到。
而实际在打开一个商品或订单页面时，背后有几十甚至上百次与后端交互，如果这么多次全部跨地域完成，意味着页面的响应时间将增加3s。对用户体验来说，页面打开很慢，甚至很多页面超时出不来了，这第一点是直接带来是业务产品不可用。对系统来说，当响应时间增高的时候，意味着同等QPS的要求下，将需付出更大的成本，因为原本吞吐能力下降了。——距离带来的延时是最大的问题。

2. 一致性
针对延时问题，采用多点写能解决这一点。但是，只要多点写了就会带来第二个最复杂的问题：数据一致性问题，也是最致命的。如订单交易多点写，用户两次访问分别在A数据中心、B数据中心写，两条数据如合不到一起的话。对用户最直观的感受是买了一个东西付了钱，然后看到可能是没付钱。或者买了一个东西，压根就没有看到购买记录。因此，多点写最大的挑战是怎么保证用户写入的数据一定是正确的地方，且是一致的。——这是异地多活最大的挑战。

## 阿里的方案

方案说明
按买家纬度路由不同单元；
在同单元内最大程度闭环；
买家纬度数据写本单元DB；通过中间件数据同步其他单元，在每个单元有全量买家数据，买家数据在跨单元最终一致性；
卖家和商品纬度数据要求强一致性，写“强依赖中心”；在每个单元也会有全量卖家和商品数据，单元内数据只提供读。

容灾能力
当某个单元故障，快速完成切换，这部分用户在短时间内只读，限制写操作；其他单元用户正常使用业务；

不足
当强依赖中心故障，业务也会在较长一段时间内（不确定性）不可用

## 总结

延时问题解决思路
单元内闭环，让更多操作在中心内完成，减少跨中心写；

一致性问题解决思路
全局路由机制，保证用户数据不要写错地方：写入DB前做好保护动作，确保用户数据不写错地方，实时数据校验系统检查是否符合期望。
不同业务区分对待，强一致性、最终一致性：数据一致性中还有一个很大的挑战是：在流量切换的动作中，比如说AB两个数据中心，A开始是承担20%的流量，B承担80%的流量。当把流量从一个地方切到另外一个地方的时间，有可能出现切换过程中你还在A数据中心写，但其实写完之后到B了，有可能看到出现的数据是不一致的。怎么保证在整个流量切换过程中数据是绝对一致的。在异地整个数据中心还有另外一个非常重要的核心技术产品，就是需要一个数据同步的能力。所有数据同步控制在1秒以内，1秒以内是可以接受的。

基本原则
核心业务双活：核心业务和次要业务需要分而治之，异地多活的业务形式越简单越好，甚至可以只做核心业务，如果业务量不大，没必要做异地多活，因为异地多活需要的运维资源成本、开发成本都非常高；
单元内最大限度闭环，只取分片纬度相关业务“多活”
异地多活的监控、部署、测试、演练等流程也要跟上；
控制跨机房消息体大小，越小越好；
无法接收最终一致性的，则跨中心写。

# **如何做SAAS化**

## 面临的挑战

1. 准备条件：服务单元化，对外接口最小化，高内聚低耦合。
2. 产品化后、组件化后的多租户支持，多租户面临的问题： 数据存储问题、数据共享问题。哪些可以共享，哪些不能

## 我们现在怎么搞的

多租户的模式，我们现在是按照所以接口增加租户编号，内部数据按租户隔离的方式进行的，以往可能分库分schema，我们是按照租户进行隔离，在saas化这方面，我上次跟陆逊兄，说的没说明白，主要说了，我们saas化之前的准备工作，比如模块划分，上下游解耦，暴露接口的简单可操作，是一些saas话产品的前提准备工作。saas化这块，因为我们也是刚刚开始做，还有大批量租户入驻的实践经验，没有踩过那么多雷，所以体会上没有那么深刻，这一块，也是我需要学习和实践的地方。

# 领域驱动设计

根据需求划分出初步的领域和限界上下文，以及上下文之间的关系；
进一步分析每个上下文内部，识别出哪些是实体，哪些是值对象；
对实体、值对象进行关联和聚合，划分出聚合的范畴和聚合根；
为聚合根设计仓储，并思考实体或值对象的创建方式；
在工程中实践领域模型，并在实践中检验模型的合理性，倒推模型中不足的地方并重构。

# 个人思考

1. 单向对账和双向，结算和收付款，支付平台对账，单向，以结算为准。
2. 单向对账：以一方数据为基准进行对账。比如结算跟支付平台，以结算数据为基准和支付平台核对，用来发现结算数据为支付成功，支付平台支付失败等问题。
3. 双向对账：以双方的数据互为基准对账。既要保证结算数据为成功的，支付平台也要成功，又要保证支付平台数据为成功的，结算数据也要成功。
4. 其实这个地方支付很少造数据，都是上游给的，可以按照结算为准。
5. 与发票数据核对的问题，先对总账，再对明细。条数，金额。结算单关单，会把明细和条数发给发票系统，它做核对。
