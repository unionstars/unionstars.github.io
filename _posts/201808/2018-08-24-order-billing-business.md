---
layout: post
title:  "计费系统"
date:   2018-07-11 12:00:00

categories: Java
tags: learningnote
author: "张学刚"
---

# 计费系统

## 名词解释

1. 订单类型（联营订单)
2. 交易类型 订单交易-正向订单，订单交易-逆向退款?
3. 交易单据号（一个原始单据（订单）拆分为多个交易单，例如：代收代付情况（分销））?
4. 交易分类：订单交易、分账交易、代付交易、订购服务?
5. 原始业务单据号(业务系统的业务单据编号（订单、退款申请单）)
6. 计费业务编号（计费系统支持的各类业务编号）
7. 业务交易(ST_FBP_SIMPLE(10, 0, 21, "普通FBP订单"),))) 简单交易（简单交易，erp类型，orderType，订单类型)
8. 订单状态(妥投/退货/订单取消)
9. 任务类型(计费任务（订单计费）/数据准备任务（数据快照准备）/同步明细任务(计费数据同步至结算))
10. 业务单据类型 1001:订单,1002:售后服务单,1003:取消退款单.1101:调整单,1102:非销售单（标准化（售前、售后））
11. 支付渠道（微信、银联、员工卡、余额）
12. 交易时间(正向为妥投时间、逆向为售后服务单完成时间)
13. 计费任务状态（初始化、处理完成、处理失败）
14. 拉平周期：联营商保底费用缴纳周期
15. 拉平周期账单：拉平周期内所有费用实时累加

## 计费系统的职责

计费系统上游承接业务系统（订单系统、售后系统），下游承接结算系统，一般在行业内把计费系统会纳入支付系统的一部分，我们来看一下支付系统中常被提及的几个概念，支付、清算、结算。

支付：完成付款人向收款人转移可以接受的货币债权的过程，包括交易过程、清算过程和结算过程等三个过程

清算：包含了在收付款人金融机构之间交换支付工具以及计算金融机构之间待结算的债权，支付工具的交换也包括交易撮合、交易清分、数据收集等。

结算：该过程是完成债权最终转移的过程，包括收集待结算的债权并进行完整性检验、保证结算资金具有可用性、结清金融机构之间的债券债务以及记录和通知各方

我们可以看到，计费的过程实际上清算的过程，他主要对债权进行清分。以联营商计费来说，当用户订单完成时，它需要将该订单商家所得、平台方所得，进行正确的清算。

拉平周期金额计算：计算拉平周期内的保底费用。

## 核心解决的问题

计费时点不同：计费一般都是由业务系统在某个时点触发，一般是监听业务系统业务行为结束的消息，比如订单系统妥投、售后系统服务单操作。

金额的计算依赖多：计算不同类型的费用一般有自己的公式，比如货款的计算公式为：货款 = 商品价格 - 优惠券，该公式所需要的商品价格和优惠券又需要从不同的系统获取。

业务多样： 理论上计费应该可以支持所有业务的计费需求，作为云计费系统输出，承接所有系统的计费需要

业务要求：可以适当延时、必须准确

那我们可以看到,计费系统核心解决的问题是，尽量隔离时点不同导致的逻辑不通用、解决依赖多的问题快速准确的进行计费。

### 数据一致性的保证

1. 计费系统接收订单系统和售后系统的MQ消息，进行计费，计费为通过MQ进行准实时的计费
2. 费用入账后（进入结算单），发送入账消息
3. 当天结束后，第二天01.00，对前一天入账的业务单据总数与订单系统和售后系统进行核对，如果不不一致进行自查（1. 查是否消息未接受，2.查是否接收了但是入账失败）
4. 拉平计费中心接收计费系统的入账消息，对入账结算单的佣金明细开始入账
5. 当天结束后，第二天01.15,对前一天的入账业务单据总数和结算系统的入账数据进行比对，比对失败将数据存入差错表，进行重试
6. 拉平周期结束，关单时，校验差错处理表，是否有未处理完成的数据，如果有，则进行关单

### 体验

1. 保底费用，实时累加，商家可实时查看保底费用金额
2. 保底费用账单单独出，可以通过点击结算明细，直接下载保底费用单据所关联的所有明细
3. 现在是增量统计，实时展示，后续可以应收应付实时展示
4. 后续商家端，可以实时查看自己的待结算费用，保底费用

### 计费系统交互时序图

### 拉平周期系统交互时序

![拉平周期系统交互时序](https://raw.githubusercontent.com/unionstars/unionstars.github.io/master/assets/images/pictures/2018-08-22-settle-period/01-01.png)

## 回到需求

1. 商家是感知佣金费用的，页面最好用户能实时感知，拉平周期内待付的佣金、待结算的金额、固定费用（用户钱包）
2. 可以到处拉平周期内待付佣金的明细

## 还有没有更好的方案

1. 结算明细按日入账、拉平周期结算和结算周期结算，都以日账单为为基准按拉平周期和结算周期进行汇总结算


<!-- ```bash
@startuml
拉平周期保底费用计算系统-[#red]> 拉平周期保底费用计算系统 : 按账户与门店创建拉平周期保底费用单
结算系统 -[#red]> 消息中间件 : 结算单据佣金费用明细
消息中间件 -[#red]> 拉平周期保底费用计算系统 : 拉取结算单据佣金费用明细
拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统 : 1. 数据有效性验证
拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统 : 2. 保存单据佣金费用明细(待通知结算)\n3. 拉平周期保底费用单\n[以上都在一个事务中进行，使用]
拉平周期保底费用计算系统 -[#red]>  结算系统 : 1. 更新结算系统通知状态(RPC)\n2. 更新单据费用明细状态（已通知结算）
拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 1. 关闭该拉平周期单据\n2. 按账户与门店维度统计拉平周期费用金额，与单数
拉平周期保底费用计算系统 -[#red]>  结算系统 : 按账户和门店获取结算系统拉平周期佣金费用总额，与订单数
结算系统--[#red]>  拉平周期保底费用计算系统 : 按账户和门店返回结算系统拉平周期佣金费用总额，与订单数
拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 对比结算系统与拉平周期保底费用计算系统的金额，与订单数
拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 数据匹配
 alt 数据匹配成功
    拉平周期保底费用计算系统 -[#red]> 商家系统: 获取商家固定费用
    拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 计算应收费用
    拉平周期保底费用计算系统 -[#red]>  结算系统 : 推送计算的拉平周期费用(RPC)
    结算系统 --[#red]>  拉平周期保底费用计算系统 : 返回拉平周期费用接收结果(RPC)
    拉平周期保底费用计算系统 -[#red]>  拉平周期保底费用计算系统 : 核销账户拉平周期单据(RPC)
  else 数据匹配失败
    拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统: 等待重试
    拉平周期保底费用计算系统 -[#red]> 拉平周期保底费用计算系统: 告警、人工处理
end

对账系统 -[#red]> 对账系统: 考虑引入？
@enduml
``` -->