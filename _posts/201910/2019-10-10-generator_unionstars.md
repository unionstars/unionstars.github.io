---
layout: post
title:  "如何通过脚手架来规范研发"
date:   2018-07-11 12:00:00

categories: tool
tags: archtecture refactoring tool
author: "XueGang Zhang"
image: /images/logo.png
comments: true
published: true
---

#### 软件架构面临的问题

Bob在在整洁架构中提到：`软件架构的终极目标是，用最小的人力成本来满足构建和维护系统的需求` ，Eric Evans在领域驱动设计中也多次强调架构设计的重要。我们也常常看到的很多三年以上的工程领域模型混乱、架构分层不合理、项目工程边界划分混乱、重复功能多。导致这种现象的原因很多，最终的原因可能是人的问题，人的软件水准参差不齐，人员流动大等等很多元素，在我跟很多大厂的朋友聊天，他们也一致的反馈了很多一致的结果，业务系统代码的逐步腐化，很整洁的业务系统很少。

更多的，我们看到很多这样的现象，一个技术复杂度简单的系统，却需要很多人去维护，对于开发者而言要7*24小时的救火，对于管理者来言，简单的功能上线的投入越来越大，如何规避这种问题呢? 上面我们说这些问题是人引起的，那解决这些问题就要在人上去解决，如果你用心发现，你会发现这样一个问题，团队与团队之间的差距是巨大的，如果一个学习氛围浓厚的团队，他们的技术输出能力，沉淀能力与其它团队相比差距是巨大的。

是的，我要聊的就是建立大家的软件的审美，建立大家的热情，建立共同的约束、共同前行沉淀文化。我一直认为写代码、写作和绘画，所有这些创造的过程是基本类似的，第一位的是你要有正确的审美，第二你要有创造的热情，第三制定规约砥砺前行。最后慢慢沉淀思想的结晶和技术文化。人员的流动是控制不了的，但是思想的沉淀却如同给后边的人留下了巨人的肩膀。


#### 如何解决这些问题

如何解决这些人的问题呢，我们可以通过招聘去招比自己更优秀的人，通过文化思想的相荡来提升大家的审美，也可以内部培养，但是更多的时候，这需要长期的建设，如何短时间内就形成一种积累呢，那就是工程纪律的建设。工程纪律可以参考性质的，比如阿里出的java开发手册以及附带的idea的检查工具；也可以是强制性的，比如在代码合并的时候增加代码规则检查，如果不通过不能进行分支合并或者上线。我们通过大量的实施发现这些宽松的或者强制的检查，虽然初期可能是不适的，但是日益积累对技术人员的影响却是巨大的，他实实在在影响了技术文化。


#### 工程纪律的实施

我们发现一个问题，如果你让研发人原去看文档，他大多不能完全按文档的规范来，但是如果你给他一个开箱即用规范框架，并且提供相关约束的样例，他大多会按照这个样例进行粘贴和修改，从而保证了代码的统一和规范。此脚手架面向的是组织或者企业内部，他比开源的规范更加细致，并打包一些自研组件。但是脚手架的思路是相同的，沉淀好的东西，形成优秀的二方库，控制和约束三方库以及代码的书写规范。

下面是脚手架实现的约束内容，有些是通过例子来约束，有些通过内置的组件进行约束。


#### 工程划分规范

比如一个电商系统我们首先去识别各个业务领域，找到各个上下文边界，划分出具体的系统。针对单个系统，我们根据系统职责的不同再进行层次的划分，这种层次的划分可以是通过system、module、package来进行，采用哪种形式，一般与该组织所处于的发展阶段相关，并不拘泥于一种划分标准。该脚手架提供了按功能进行工程创建的模板。按功能划分我们一个小的业务领域一般有如下工程拿一个支付里边的账务领域来说。面向后端我们一般要有一个服务中心，承载的是该工程的后端服务。面向商户我们一般要有一个商家管理端，面向支付公司公司运营我们一般要有一个运营管理端，面向用户我们要有一个门户，面向app我们一般要有一个app端，并且我们一般要有一个网关来对app端提供服务，如果提供一些远程调用的服务，如果接口不放在中心的话，我们还要有一个接口工程。这些工程所提供的功能不同模板不同，就名称而言，以上的工程类似于如下的命名。`accounting-center  accounting-shop  accounting-man accounting-portal accounting-app accounting-gateway accounting-api`，

`该规范通过脚手架为不同的功能模块提供快速生成的模板`


#### 架构分层

架构分层是架构领域里边讨论了又讨论的问题，一般都是遵循SOLID原则去分，但是分的形式也有很多，在微服务兴起之后，DDD又被重提并得到了很多应用，无论上战略和战术方面都对行业有一定的影响，其中这微软更是在推广自己容器化的时候提供了一套基于DDD的.net应用程式架构的demo，java领域里完整实施DDD的应用并不多，这里并没有用DDD的分层命名和组织方式，采用了传统的分层架构。不过相信在不断的实践过程中，基于DDD思想一定会创造出更多的优秀框架。

`该规范通过脚手架快速生成符合此规范的分包项目`

#### 域名使用规范

#### mysql规范

``````sql
/*
  Mysql 规范
*/

-- ----------------------------
-- 库的字符集必须使用utf8
-- ----------------------------
CREATE DATABASE test CHARACTER SET utf8;
USE test;

-- ----------------------------
-- 有无符号:unsigned必须填；
-- 主键自增:AUTO_INCREMENT必填;
-- 表的引擎:ENGINE=Innodb必填;
-- 自增起值:AUTO_INCREMENT=xx必填;
-- 表字符集:CHARSET=utf8必填;
-- 表的注释:COMMENT="用户表"必填;
-- 字段注释:COMMENT="自增id"必填;
-- ----------------------------
DROP TABLE IF EXISTS `t_user`;
CREATE TABLE `t_user`
(
  `id`       int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '自增id',
  `name`     varchar(100)     NOT NULL COMMENT '姓名',
  `age`      int(11)          NOT NULL COMMENT '年龄',
  `addr`     varchar(200) DEFAULT NULL COMMENT '地址',
  `created`  datetime         NOT NULL COMMENT '创建时间',
  `modified` datetime         NOT NULL COMMENT '修改时间',
  PRIMARY KEY (`id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8 COMMENT = '用户表';

INSERT INTO t_user (name, age, addr)
VALUES ('Jack', 20, 'BJ');
INSERT INTO t_user (name, age, addr)
VALUES ('Jones', 18, 'SH');

-- ----------------------------
-- 增加字段时COMMENT必须填写
-- ----------------------------
ALTER TABLE t_user ADD COLUMN code VARCHAR (20) NULL COMMENT '用户编码';

-- ----------------------------
-- 唯一索引用uq_开头;
-- 索引名称必须以idx开头;
-- ----------------------------
ALTER TABLE t_user ADD INDEX uq_name(code) USING BTREE COMMENT '用户编码唯一索引';
ALTER TABLE t_user ADD INDEX idx_name(name) USING BTREE COMMENT '用户名称索引';
```

`该规范通过脚手架生成项目中的/resources/db/schema.sql提供示例规范`


#### 组件使用规范

| 基础组件    | 版本          | 组件是否可拆卸 | 版本是否可选择 |
| ----------- | ------------- | -------------- | -------------- |
| spring-boot | 2.1.7.RELEASE | 必须选择       | 可输入版本     |
| jdk         | 1.8           | 必须选择       | 可输入版本     |
| lombok      | 1.18.8        |                |                |
| gson        | 2.8.5         |                |                |
| jsf         | 1.6.9         |                |                |

`该规范基础组件使用内置的版本，所有组件使用spring生态进行构建，对于开源组件提供了starter的统一使用starter的方式使用，对于没有提供starter的组件统一封装starter进行使用，非基础用户可按需选择`

#### 日志使用规范
应用中不能使用日志系统(Log4j、Logback)中的api，而应该依赖日志框架中slf4j中的API，使用门面模式的日志框架，本工程中默认使用SpringBoot默认使用的方式slf4j+Logback.

尽量用英文来描述日志错误信息，如果日志中的错误信息用英文描述不清楚的话使用中文描述即可，负责容易产生歧义

异常信息应该包括两类信息：案发现场信息和异常堆栈信息。如果不处理那么通过关键字throws往上抛出，交给上层处理。例如：`log.error("Transaction accounting faied, transactionId: {}, orderId: {} , case: ", tradeOrderDetailId, orderId, e);`

谨慎的记录日志。业务系统与中间件的日志记录方式有比较大的差别，中间件一般在认为稳定版本的时候，就不太需要debug和info级别的信息了，或者说这些信息不关键了，业务系统，一般对日志的使用规范要有一个明确的约束，这些约束决定了生产环境中将开启什么样的日志级别。每天的日志量的预估。这里建议生产环境使用info级别的日志，预发环境可以使用debug级别日志。

dubbo/jsf，一般的远程调用接口，在日志记录的时候，最好统一记录调用者的ip,appId,appName等核心信息方便问题的定位。

`该规范通过脚手架生成项目中的/resources/logback.groovy提供日志的规范，其中使用规范在脚手架中附带的demo例子中对日志的使用规范进行了示例`

#### 编程规范

代码中的命名均不能以下划线或美元符号开始，也不能以下划线或美元符号结束；严禁使用拼音与英文混合的方式，更不允许直接使用中文的方式。`正确的英文拼写和语法可以让阅读者易于理解，避免歧义。注意，纯拼音命名方式更要避免采用`

类名使用UpperCamelCase风格，但以下情形例外:DO/BO/DTO/VO/AO / PO / UID 等；方法名、参数名、成员变量、局部变量都统一使用lowerCamelCase风格，必须遵 从驼峰形式；常量命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。

抽象类命名使用Abstract或Base开头;异常类命名使用Exception结尾;测试类 命名以它要测试的类的名称开始，以 Test 结尾； 类型与中括号相连来标识数组。

POJO类中布尔类型变量都不要加is前缀，否则部分框架解析会引起序列化错误；包名统一使用小写，点分隔符之间有且仅有一个自然语义的英语单词。包名统一使 用单数形式，但是类名如果有复数含义，类名可以使用复数形式。`应用工具类包名为 com.alibaba.ai.util、类名为 MessageUtils(此规则参考 spring 的框架结构)`；避免在子父类的成员变量之间、或者不同代码块的局部变量之间采用完全相同的命
名，使可读性降低。

杜绝完全不规范的缩写，避免望文不知义；为了达到代码自解释的目标，任何自定义编程元素在命名时，使用尽量完整的单词 组合来表达其意；在常量与变量的命名时，表示类型的名词放在词尾，以提升辨识度；如果模块、接口、类、方法使用了设计模式，在命名时需体现出具体模式。

接口类中的方法和属性不要加任何修饰符号(public 也不要加)，保持代码的简洁 性，并加上有效的 Javadoc 注释。尽量不要在接口里定义变量，如果一定要定义变量，肯定 是与接口方法相关，并且是整个应用的基础常量。

接口和实现类的命名有两套规则:对于 Service 和 DAO 类，基于 SOA 的理念，暴露出来的服务一定是接口，内部的实现类用Impl 的后缀与接口区别；如果是形容能力的接口名称，取对应的形容词为接口名(通常是–able 的形容词)


`该规范引用子阿里巴巴Java开发手册，此手册对内容的定义已经比较完善了，脚手架中示例并没有刻意去实现这些规范，所以只是涉及到了一部分，其他规范可参考此规范作为组织规范的基础`

#### 获取脚手架!!!

现在基于以上的原则，我们提供了一个开箱即用的工程，参考本文档你仅仅需要几步就可以生成一个开箱即用的工程，并且提供了多种工程模板，api工程、rest风格的工程、center工程。脚手架的命名命名为unionstars，是联合众星的意思，也是希望将好的思想沉淀在脚手架中。工程里对应的原则在脚手架中尽可能的涉及，但是并不刻意去做这件事情，脚手架的核心宗旨不会变化。`用unionstars！几行命名，秒级进入coding状态！`

**安装 Node.js**

First you must setup [Node.js](https://www.runoob.com/nodejs/nodejs-install-setup.html)

**安装 Yeoman**

```
$ npm install -g yo
```

**安装 generator-unionstars**

```
$ npm install -g generator-unionstars
```

**初始化一个开箱即用的后端服务中心工程**

```
$ yo unionstars
```
_The interactive CLI menu will guide the way._


**初始化一个接口工程(Jsf)**

```
$ yo unionstars:api
```


**初始化一个前端网关工程(Rest)**

```
$ yo unionstars:gateway
```

## TODO

- shop端模板工程提供;
- man端模板工程提供;
- portal模板工程提供;
- app模板工程提供;

## License

[MIT License](http://en.wikipedia.org/wiki/MIT_License)





